name: Auto Create Branch with ISSUE

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: read

jobs:
  create-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@4

      - name: Extract Label
        id: extract-label
        run: |
          # ë ˆì´ë¸”ì´ ì—†ëŠ” ê²½ìš° "other"ë¡œ ê¸°ë³¸ê°’ ì„¤ì •
          if [ -z "${{ toJson(github.event.issue.labels) }}" ]; then
            echo "label=other" >> $GITHUB_ENV
          else
            LABEL=$(echo '${{ toJson(github.event.issue.labels) }}' | jq -r '.[0].name')
            echo "label=${LABEL}" >> $GITHUB_ENV
          fi

      - name: Extract Keyword
        id: extract-keyword
        run: |
          # ì´ìŠˆ ë³¸ë¬¸ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ
          KEYWORD=$(echo "${{ github.event.issue.body }}" | grep -A1 '### ðŸ”‘ Keyword' | tail -1 | tr -d '\r' | xargs)
          # í‚¤ì›Œë“œê°€ ì—†ìœ¼ë©´ ì´ìŠˆ ë²ˆí˜¸ë§Œ ì‚¬ìš©
          if [ -z "$KEYWORD" ]; then
            KEYWORD="issue-${{ github.event.issue.number }}"
          fi
          # ë¸Œëžœì¹˜ëª…ì— í—ˆìš©ë˜ì§€ ì•ŠëŠ” ë¬¸ìž ë³€í™˜
          SANITIZED_KEYWORD=$(echo "$KEYWORD" | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]-' | sed 's/--/-/g')
          echo "keyword=${SANITIZED_KEYWORD}" >> $GITHUB_ENV

      - name: Sanitize Label
        id: sanitize-label
        run: |
          # ë ˆì´ë¸”ëª… ë¬´íš¨ ë¬¸ìž ì²˜ë¦¬
          RAW_LABEL="${{ env.label }}"
          SANITIZED_LABEL=$(echo "$RAW_LABEL" | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]-' | sed 's/--/-/g')
          echo "sanitized_label=${SANITIZED_LABEL}" >> $GITHUB_ENV

      - name: Create Branch
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          BRANCH_NAME="${{ env.sanitized_label }}/$ISSUE_NUMBER/${{ env.keyword }}"
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
