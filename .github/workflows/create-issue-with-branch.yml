name: Auto Create Branch with ISSUE

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: read

jobs:
  create-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: dev  # dev 브랜치 체크아웃

      - name: Pull latest dev
        run: git pull origin dev

      - name: Extract Label
        id: extract-label
        run: |
          if [ -z "${{ toJson(github.event.issue.labels) }}" ]; then
            echo "label=other" >> $GITHUB_ENV
          else
            LABEL=$(echo '${{ toJson(github.event.issue.labels) }}' | jq -r '.[0].name')
            echo "label=${LABEL}" >> $GITHUB_ENV
          fi

      - name: Extract Keyword
        id: extract-keyword
        run: |
          KEYWORD=$(echo "${{ github.event.issue.body }}" | grep -A1 '### 🔑 Keyword' | tail -1 | tr -d '\r' | xargs)
          if [ -z "$KEYWORD" ]; then
            KEYWORD="issue-${{ github.event.issue.number }}"
          fi
          SANITIZED_KEYWORD=$(echo "$KEYWORD" | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]-' | sed 's/--/-/g')
          echo "keyword=${SANITIZED_KEYWORD}" >> $GITHUB_ENV

      - name: Sanitize Label
        id: sanitize-label
        run: |
          RAW_LABEL="${{ env.label }}"
          SANITIZED_LABEL=$(echo "$RAW_LABEL" | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]-' | sed 's/--/-/g')
          echo "sanitized_label=${SANITIZED_LABEL}" >> $GITHUB_ENV

      - name: Create Branch
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          BRANCH_NAME="${{ env.sanitized_label }}/$ISSUE_NUMBER/${{ env.keyword }}"
          
          # dev 브랜치를 기준으로 새 브랜치 생성
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
